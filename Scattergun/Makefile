# Copyright 2015-2016 Digital Aggregates Corporation, Colorado, USA.
# "Digital Aggregates Corporation" is a registered trademark.
# Licensed under the terms of the GNU GPL v2.
# https://github.com/coverclock/com-diag-scattergun
# mailto:coverclock@diag.com

################################################################################

PROJECT=scattergun

ROOT=$(HOME)/src

USNISTGOV_ROOT=$(ROOT)/usnistgov/SP800-90B_EntropyAssessment
USNISTGOV_ROOT+=$(ROOT)/usnistgov/SP800-90B_EntropyAssessment/cpp
QUANTIS_ROOT=$(ROOT)/idq-quantis
BITBABBLER_ROOT=$(ROOT)/bit-babbler-0.5

OUT=out/host/bin

export SCATTERGUN_SOURCE
export SCATTERGUN_DIRECTORY

################################################################################

COMMON  = $(OUT)/setup
COMMON += $(OUT)/bytes
COMMON += $(OUT)/rate
COMMON += $(OUT)/cmrand48
COMMON += $(OUT)/crandom
COMMON += $(OUT)/seed
COMMON += $(OUT)/characterize.sh
COMMON += $(OUT)/consume.sh
COMMON += $(OUT)/entropy.sh
COMMON += $(OUT)/monitor.sh
COMMON += $(OUT)/onernginit.sh
COMMON += $(OUT)/scattergun.sh
COMMON += $(OUT)/truerngd.sh
COMMON += $(OUT)/getrandom

QUANTUM  = $(OUT)/quantistool

BROADWELL  = $(OUT)/seventool
BROADWELL += $(OUT)/seventool-binary
BROADWELL += $(OUT)/seventool-mnemonic

ALL  = $(COMMON)
ALL += $(QUANTUM)
ALL += $(BROADWELL)

default:	common

common:	$(COMMON)

quantum:	$(COMMON) $(QUANTUM)

broadwell:	$(COMMON) $(BROADWELL)

all:	$(ALL)

clean:
	rm -rf $(ALL)

.PHONY: default common quantum broadwell all clean

################################################################################

# Continuously output eight-bit binary bytes with the value zero. If an
# argument is specified, a byte with that value is output instead.

$(OUT)/bytes:	src/bytes.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Continuously output 32-bit binary numbers generated by the C library's
# mrand48(3) function. These numbers will range in value from -2^31 to 2^31. If
# an argument is specified, it is used to seed the pseudo-random number
# generator.

$(OUT)/cmrand48:	src/cmrand48.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Continuously output 32-bit binary numbers generated by the C library's
# random(3) function. These numbers will range in value from 0 to RAND_MAX,
# which on one of my Ubuntu 14.04 systems is defined in <stdlib.h> to be
# 2,147,483,647 or 0x7fffffff. If an argument is specified, it is used to seed
# the pseudo-random number generator.

$(OUT)/crandom:	src/crandom.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Continuously output 32-bit binary numbers generated by the Linux kernel's
# getrandom(2) system call.

$(OUT)/getrandom:	src/getrandom.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Continuously reads data from a Quantis hardware entropy generator,
# manufactured by ID Quantique, and writes it to standard output, or to a
# specified file system path.

QUANTIS_INCPATH=$(QUANTIS_ROOT)/Libs-Apps/Quantis
QUANTIS_LIBPATH=$(QUANTIS_ROOT)/Libs-Apps/build/Quantis

QUANTIS_CFLAGS += -I$(QUANTIS_INCPATH)
#QUANTIS_LDFLAGS += -L$(QUANTIS_LIBPATH)
#QUANTIS_LDFLAGS += -lQuantis
QUANTIS_LDFLAGS += $(QUANTIS_LIBPATH)/libQuantis.a
QUANTIS_LDFLAGS += -lusb-1.0
QUANTIS_LDFLAGS += -lpthread

$(OUT)/quantistool: src/quantistool.c
	$(CC) $(CFLAGS) $(QUANTIS_CFLAGS) -o $@ $^ $(LDFLAGS) $(QUANTIS_LDFLAGS)

################################################################################

# Continuously reads thirty-two bits of entropy using the rdrand or rdseed
# instructions available on various Intel processors such as certain models of
# the i7 and writes it to standard output, or to a specified file system path.

$(OUT)/seventool:	$(OUT)/seventool-mnemonic
	cp $^ $@

$(OUT)/seventool-binary: src/seventool.c
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

SEVEN_MNEMONIC += -DSCATTERGUN_HAS_RDRAND_MNEMONIC
SEVEN_MNEMONIC += -DSCATTERGUN_HAS_RDSEED_MNEMONIC

$(OUT)/seventool-mnemonic: src/seventool.c
	$(CC) $(CFLAGS) $(SEVEN_MNEMONIC) -o $@ $^ $(LDFLAGS)

SEVEN_INTRINSIC += -DSCATTERGUN_HAS_RDRAND_INTRINSIC
SEVEN_INTRINSIC += -DSCATTERGUN_HAS_RDSEED_INTRINSIC

$(OUT)/seventool-intrinsic: src/seventool.c
	$(CC) $(CFLAGS) $(SEVEN_INTRINSIC) -o $@ $^ $(LDFLAGS)

SEVEN_INLINE += -DSCATTERGUN_HAS_RDRAND_INLINE
SEVEN_INLINE += -DSCATTERGUN_HAS_RDSEED_INTRINSIC

$(OUT)/seventool-inline: src/seventool.c
	$(CC) $(CFLAGS) $(SEVEN_INLINE) -o $@ $^ $(LDFLAGS)

################################################################################

# Measures the sustained and peak rates of a data source. Optionally outputs
# a comma separated value (CSV) file of performance metrics with the specified
# period.

$(OUT)/rate:	src/rate.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Generate an unsigned integer (-i) or an unsigned long (-l) seed.

$(OUT)/seed:	src/seed.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

$(OUT)/characterize.sh:	bin/characterize.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/consume.sh:	bin/consume.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/entropy.sh:	bin/entropy.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/monitor.sh:	bin/monitor.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/onernginit.sh:	bin/onernginit.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/scattergun.sh:	bin/scattergun.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/truerngd.sh:	bin/truerngd.sh
	cp $^ $@
	chmod 775 $@

################################################################################

$(OUT)/setup:
	mkdir -p $(dir $@)
	cp /dev/null $@
	echo export PATH=$(shell pwd)/$(dir $@):$(USNISTGOV_ROOT):$(BITBABBLER_ROOT):$(PATH) >> $@
	echo export LD_LIBRARY_PATH=$(QUANTIS_LIBPATH):$(LD_LIBRARY_PATH) >> $@

export PATH:=$(shell pwd)/$(OUT):$(USNISTGOV_ROOT):$(BITBABBLER_ROOT):$(PATH)
export LD_LIBRARY_PATH:=$(QUANTIS_LIBPATH):$(LD_LIBRARY_PATH)

verify:
	echo sudo apt-get install netpbm
	which rawtoppm
	which pnmtopng
	echo sudo apt-get install rng-tools
	which rngtest
	echo sudo apt-get install ent # http://www.fourmilab.ch/random/random.zip
	which ent
	echo sudo apt-get install python
	which python
	echo git clone http://github.com/usnistgov/SP800-90B_EntropyAssessment
	which iid_main.py || which ea_iid
	which noniid_main.py || which ea_non_iid
	echo sudo apt-get install dieharder
	which dieharder

.PHONY:	verify

################################################################################

job:
	mkdir -p $(SCATTERGUN_DIRECTORY)
	( cd $(SCATTERGUN_DIRECTORY); exec nohup make -f ../Makefile test & jobs )

.PHONY:	job

test:
	( $(SCATTERGUN_SOURCE) | scattergun.sh ) > scattergun.log 2>&1

.PHONY:	test

################################################################################
# "Silver"
# Dell Inspiron 530
# Intel Core 2 Q6600 @ 2.4GHz x 4
# Ubuntu 14.04 "trusty"
# Linux 3.13.0
# gcc 4.8.2
################################################################################

TARGET=silver

################################################################################

# TrueRNGpro
# ublt.it
# US$99.00
# http://ubld.it/products/truerngpro
# 3.2Mbps
# USB
# semiconductor avalanche effect

TRUERNGPRO:=$(PROJECT)_$(TARGET)_TrueRNGpro

$(TRUERNGPRO):	/dev/TrueRNGpro
	make job SCATTERGUN_SOURCE="dd if=/dev/TrueRNGpro" SCATTERGUN_DIRECTORY=$(TRUERNGPRO)

################################################################################

# Quantis-USB-4M
# ID Quantique
# Euro$990.00 (US$1100.00)
# http://www.idquantique.com/random-number-generation/quantis-random-number-generator/
# 4Mbps
# USB
# beam splitter with photon counter

QUANTIS:=$(PROJECT)_$(TARGET)_quantis

$(QUANTIS):	src/quantistool
	make job SCATTERGUN_SOURCE="quantistool -v" SCATTERGUN_DIRECTORY=$(QUANTIS)

################################################################################

# OneRNG
# Moonbase Otago
# US$40.00
# http://onerng.info
# 350Kbps
# USB
# semiconductor avalanche effect (and optionally atmospheric noise)

ONERNG:=$(PROJECT)_$(TARGET)_OneRNG

$(ONERNG):	/dev/OneRNG
	make job SCATTERGUN_SOURCE="dd if=/dev/OneRNG" SCATTERGUN_DIRECTORY=$(ONERNG)

################################################################################

# drivers/char/random.c

URANDOM:=$(PROJECT)_$(TARGET)_urandom

$(URANDOM):	/dev/urandom
	make job SCATTERGUN_SOURCE="dd if=/dev/urandom" SCATTERGUN_DIRECTORY=$(URANDOM)

################################################################################

# drivers/char/random.c

RANDOM:=$(PROJECT)_$(TARGET)_random

$(RANDOM):	/dev/random
	make job SCATTERGUN_SOURCE="dd if=/dev/random" SCATTERGUN_DIRECTORY=$(RANDOM)

################################################################################
# "Betty"
# Raspberry Pi 2 Model B v1.1
# Broadcom BCM2836 Cortex-A7 ARMv7 x 4
# Raspbian (Debian) 7.8
# Linux 3.8.11
# gcc 4.6.3
################################################################################

TARGET=betty

################################################################################

# bcm2708 HWRNG
# Raspberry Pi 2 B (Broadcom BCM2836 SoC)
# US$35.00
# https://www.raspberrypi.org/products/raspberry-pi-2-model-b/
# undocumented
# drivers/char/hw_random/bcm2708-rng.c
# unknown

BCM2708_2:=$(PROJECT)_$(TARGET)_bcm2708

$(BCM2708_2):	/dev/hwrng
	make job SCATTERGUN_SOURCE="dd if=/dev/hwrng" SCATTERGUN_DIRECTORY=$(BCM2708_2)

################################################################################
# "Shortcake"
# Raspberry Pi 3 Model B v1.2
# Broadcom BCM2837 Cortex-A53 ARMv7 x4
# Raspbian (Debian) 8.0
# Linux 4.1.19
# gcc 4.9.2
################################################################################

TARGET=shortcake

################################################################################

# bcm2708 HWRNG
# Raspberry Pi 3 B (Broadcom BCM2837 SoC)
# US$35.00
# https://www.raspberrypi.org/products/raspberry-pi-3-model-b/
# undocumented
# drivers/char/hw_random/bcm2708-rng.c
# unknown

BCM2708_3:=$(PROJECT)_$(TARGET)_bcm2708

$(BCM2708_3):	/dev/hwrng
	make job SCATTERGUN_SOURCE="dd if=/dev/hwrng" SCATTERGUN_DIRECTORY=$(BCM2708_3)

################################################################################
# "Mercury"
# Dell OptiPlex 7040
# Intel Core i7-6700T @ 2.8GHz x 8
# Ubuntu 14.04.4 "trusty"
# Linux 4.2.0
# gcc 4.8.4
################################################################################

TARGET=mercury

################################################################################

# TrueRNG v2
# ublt.it
# US$49.95
# http://ubld.it/products/truerng-hardware-random-number-generator/
# 350Kbps
# USB
# semiconductor avalanche effect

TRUERNG:=$(PROJECT)_$(TARGET)_TrueRNG

$(TRUERNG):	/dev/TrueRNG
	make job SCATTERGUN_SOURCE="dd if=/dev/TrueRNG" SCATTERGUN_DIRECTORY=$(TRUERNG)

################################################################################

# NeuG
# GNU Press
# US$50.00
# https://shop.fsf.org/storage-devices/neug-usb-true-random-number-generator
# N/A
# USB
# ADC noise

NEUG:=$(PROJECT)_$(TARGET)_NeuG

$(NEUG):	/dev/NeuG
	make job SCATTERGUN_SOURCE="dd if=/dev/NeuG" SCATTERGUN_DIRECTORY=$(NEUG)

################################################################################

# Trusted Computing Module TCG 1.2 FW 5.81
# Winbond Electronics Corporation (0x57454300 "WEC")
# N/A
# N/A
# N/A
# drivers/char/hw_random/tpm-rng.ko
# N/A

TPMWEC:=$(PROJECT)_$(TARGET)_TPMWEC

# cat /sys/class/tpm/tpm0/device/caps
# modprobe tpm-rng
# sudo chmod 666 /dev/hwrng
## /home/jsloan/src/com-diag-scattergun/Scattergun/out/host/bin/scattergun.sh: line 104: 27193 Killed
## python noniid_main.py
## https://stackoverflow.com/questions/25000496/python-script-terminated-by-sigkill-rather-than-throwing-memoryerror
## https://serverfault.com/questions/362589/effects-of-configuring-vm-overcommit-memory/510857#510857
# sudo vi /etc/sysctl.conf
# vm.overcommit_memory = 2
# vm.overcommit_ratio = 100

$(TPMWEC):	/dev/tpm0 /dev/hwrng
	test -r /dev/hwrng
	make job SCATTERGUN_SOURCE="dd if=/dev/hwrng" SCATTERGUN_DIRECTORY=$(TPMWEC)

################################################################################

# BitBabbler White
# VoiceTronix Pty. Ltd.
# AUS$199.00
# https://bitbabbler.org
# 2.5Mbps
# USB
# Shot, Johnson-Nyquist, Flicker, RF noise

BITBABBLERWHITE:=$(PROJECT)_$(TARGET)_BitBabblerWhite

$(BITBABBLERWHITE):	/dev/BitBabbler
	make job SCATTERGUN_SOURCE="seedd -o -c none" SCATTERGUN_DIRECTORY=$(BITBABBLERWHITE)

################################################################################

# rdrand Deterministic Random Bit Generator (DRBG)
# Intel Ivy Bridge family
# N/A
# https://software.intel.com/en-us/articles/intel-digital-random-number-generator-drng-software-implementation-guide
# 800MBps
# arch/x86/include/asm/archrandom.h
# AES-CBC-MAC, NIST SP800-90A compliant, thermal noise

RDRAND:=$(PROJECT)_$(TARGET)_rdrand

$(RDRAND):	$(OUT)/seventool
	make job SCATTERGUN_SOURCE="seventool -v -R -r -c" SCATTERGUN_DIRECTORY=$(RDRAND)

################################################################################

# rdseed Enhanced Non-deterministic Random Number Generator (ENRNG)
# Intel Broadwell family
# N/A
# https://software.intel.com/en-us/articles/intel-digital-random-number-generator-drng-software-implementation-guide
# N/A
# arch/x86/include/asm/archrandom.h
# NIST SP800-90B and C compliant, thermal noise

RDSEED:=$(PROJECT)_$(TARGET)_rdseed

$(RDSEED):	$(OUT)/seventool
	make job SCATTERGUN_SOURCE="seventool -v -S -c" SCATTERGUN_DIRECTORY=$(RDSEED)

################################################################################

FAIL:=$(PROJECT)_$(TARGET)_fail

$(FAIL):	$(OUT)/seventool
	make job SCATTERGUN_SOURCE="seventool -v" SCATTERGUN_DIRECTORY=$(FAIL)

################################################################################

CMRAND48:=$(PROJECT)_$(TARGET)_cmrand48

$(CMRAND48):	$(OUT)/cmrand48
	make job SCATTERGUN_SOURCE="cmrand48" SCATTERGUN_DIRECTORY=$(CMRAND48)

################################################################################

CRANDOM:=$(PROJECT)_$(TARGET)_crandom

$(CRANDOM):	$(OUT)/crandom
	make job SCATTERGUN_SOURCE="crandom" SCATTERGUN_DIRECTORY=$(CRANDOM)

################################################################################

ZEROS:=$(PROJECT)_$(TARGET)_zeros

$(ZEROS):	$(OUT)/bytes
	make job SCATTERGUN_SOURCE="bytes 0x00" SCATTERGUN_DIRECTORY=$(ZEROS)

################################################################################
# "Nickel"
# Intel NUC5i7RYH
# Intel Core i7-5557U @ 3.10GHz x 8
# Ubuntu 16.04.1 "xenial"
# Linux 4.4.0
# gcc 5.4.0
################################################################################

TARGET=nickel

################################################################################

# BitBabbler Black
# VoiceTronix Pty. Ltd.
# AUS$49.00
# https://bitbabbler.org
# 625Kbps
# USB
# Shot, Johnson-Nyquist, Flicker, RF noise

BITBABBLERBLACK:=$(PROJECT)_$(TARGET)_BitBabblerBlack

$(BITBABBLERBLACK):	/dev/BitBabbler
	make job SCATTERGUN_SOURCE="seedd -o -c none" SCATTERGUN_DIRECTORY=$(BITBABBLERBLACK)

################################################################################

# TrueRNG v3
# ublt.it
# US$49.95
# http://ubld.it/products/truerng-hardware-random-number-generator/
# 400Kbps
# USB
# semiconductor avalanche effect

TRUERNG:=$(PROJECT)_$(TARGET)_TrueRNGv3

$(TRUERNG):	/dev/TrueRNG
	make job SCATTERGUN_SOURCE="dd if=/dev/TrueRNG" SCATTERGUN_DIRECTORY=$(TRUERNG)

################################################################################

# Chaos Key
# Altus Metrium via Garbee and Garbee
# US$40.00
# http://altusmetrum.org/ChaosKey/
# N/A
# USB
# Shot

CHAOSKEY:=$(PROJECT)_$(TARGET)_ChaosKey

$(CHAOSKEY):	/dev/chaoskey0
	make job SCATTERGUN_SOURCE="dd if=/dev/chaoskey0" SCATTERGUN_DIRECTORY=$(CHAOSKEY)

################################################################################

# Infinite Noise
# Wayward Geek via Tindie
# US$35.00
# https://www.tindie.com/products/WaywardGeek/infinite-noise-true-random-number-generator/
# 150Kbps
# USB
# Thermal

INFINITENOISE:=$(PROJECT)_$(TARGET)_InfiniteNoise

$(INFINITENOISE):	/usr/local/bin/infnoise
	make job SCATTERGUN_SOURCE="/usr/local/bin/infnoise" SCATTERGUN_DIRECTORY=$(INFINITENOISE)

# N.B. /usr/local/bin/infnoise must be SETUID root.
# -rwsrwsr-x 1 root root 37488 Apr 21 15:19 /usr/local/bin/infnoise

################################################################################

# OneRNG v3.0
# Moonbase Otago
# US$40.00
# http://onerng.info
# 350Kbps
# USB
# semiconductor avalanche effect (and optionally atmospheric noise)

ONERNGV30:=$(PROJECT)_$(TARGET)_OneRNGv30

$(ONERNGV30):	/dev/OneRNG
	make job SCATTERGUN_SOURCE="dd if=/dev/OneRNG" SCATTERGUN_DIRECTORY=$(ONERNGV30)

################################################################################
# "Jaguar"
# Kontron ComExpress CBL6R901.001 X64
# Intel Core i7-5650U @ 2.20GHz x 4
# Centos 7.2.1511
# Linux 3.10.0-327.28.3.el8.x86_64
# gcc 4.8.5
################################################################################

TARGET=jaguar

################################################################################

# AT97SC3204 Trusted Computing Module 1.2
# Atmel
# N/A
# http://www.atmel.com/Images/Atmel-5295S-TPM-AT97SC3204-LPC-Interface-Datasheet-Summary.pdf http://csrc.nist.gov/groups/STM/cmvp/documents/140-1/140sp/140sp2014.pdf
# N/A
# drivers/char/hw_random/tpm-rng.ko
# N/A

AT97SC3204:=$(PROJECT)_$(TARGET)_AT97SC3204

$(AT97SC3204):	/dev/tpm0 /dev/hwrng
	make job SCATTERGUN_SOURCE="dd if=/dev/hwrng" SCATTERGUN_DIRECTORY=$(AT97SC3204)

################################################################################

# rdrand Deterministic Random Bit Generator (DRBG)
# Intel Ivy Bridge family
# N/A
# https://software.intel.com/en-us/articles/intel-digital-random-number-generator-drng-software-implementation-guide
# 800MBps
# arch/x86/include/asm/archrandom.h
# AES-CBC-MAC, NIST SP800-90A compliant, thermal noise

JAGUARRDRAND:=$(PROJECT)_$(TARGET)_rdrand

$(JAGUARRDRAND):
	make job SCATTERGUN_SOURCE="seventool -v -R -r -c" SCATTERGUN_DIRECTORY=$(JAGUARRDRAND)

JAGUARRDRANDWOR:=$(PROJECT)_$(TARGET)_rdrandwor

$(JAGUARRDRANDWOR):
	make job SCATTERGUN_SOURCE="seventool -R -c" SCATTERGUN_DIRECTORY=$(JAGUARRDRANDWOR)

################################################################################

# rdseed Enhanced Non-deterministic Random Number Generator (ENRNG)
# Intel Broadwell family
# N/A
# https://software.intel.com/en-us/articles/intel-digital-random-number-generator-drng-software-implementation-guide
# N/A
# arch/x86/include/asm/archrandom.h
# NIST SP800-90B and C compliant, thermal noise

JAGUARRDSEED:=$(PROJECT)_$(TARGET)_rdseed

$(JAGUARRDSEED):
	make job SCATTERGUN_SOURCE="seventool -v -S -c" SCATTERGUN_DIRECTORY=$(JAGUARRDSEED)

################################################################################
# "Cadmium"
# Intel NUC7i7BNH
# Intel Core i7-7567U @ 3.5GHz x 2 x 2
# Ubuntu 19.04 "disco"
# Linux 5.0.0
# gcc 8.3.0
################################################################################

TARGET=cadmium

################################################################################

# getrandom(2) system call with the GRND_RANDOM flag
# /dev/random pool fed by rngd using a TrueRNG v3 (see above)

GETRANDOMR:=$(PROJECT)_$(TARGET)_getrandomr

$(GETRANDOMR):	$(OUT)/getrandom
	make job SCATTERGUN_SOURCE="getrandom -r" SCATTERGUN_DIRECTORY=$(GETRANDOMR)
