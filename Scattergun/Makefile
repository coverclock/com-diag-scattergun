# Copyright 2015-2016 Digital Aggregates Corporation, Colorado, USA.
# "Digital Aggregates Corporation" is a registered trademark.
# Licensed under the terms of the GNU GPL v2.
# https://github.com/coverclock/com-diag-scattergun
# mailto:coverclock@diag.com

################################################################################

ROOT=$(HOME)/src

USNISTGOV_ROOT=$(ROOT)/usnistgov/SP800-90B_EntropyAssessment
QUANTIS_ROOT=$(ROOT)/idq-quantis

OUT=out/host/bin

################################################################################

ALL  = $(OUT)/setup
ALL += $(OUT)/bytes
ALL += $(OUT)/rate
ALL += $(OUT)/cmrand48
ALL += $(OUT)/crandom
ALL += $(OUT)/quantistool
ALL += $(OUT)/seventool
ALL += $(OUT)/seventool-binary
ALL += $(OUT)/seventool-mnemonic
ALL += $(OUT)/characterize.sh
ALL += $(OUT)/consume.sh
ALL += $(OUT)/entropy.sh
ALL += $(OUT)/monitor.sh
ALL += $(OUT)/onernginit.sh
ALL += $(OUT)/scattergun.sh
ALL += $(OUT)/truerngd.sh

all:	$(ALL)

clean:
	rm -rf $(ALL)

.PHONY: all clean

################################################################################

# Continuously output eight-bit binary bytes with the value zero. If an
# argument is specified, a byte with that value is output instead.

$(OUT)/bytes:	src/bytes.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Continuously output 32-bit binary numbers generated by the C library's
# mrand48(3) function. These numbers will range in value from -2^31 to 2^31. If
# an argument is specified, it is used to seed the pseudo-random number
# generator.

$(OUT)/cmrand48:	src/cmrand48.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Continuously output 32-bit binary numbers generated by the C library's
# random(3) function. These numbers will range in value from 0 to RAND_MAX,
# which on one of my Ubuntu 14.04 systems is defined in <stdlib.h> to be
# 2,147,483,647 or 0x7fffffff. If an argument is specified, it is used to seed
# the pseudo-random number generator.

$(OUT)/crandom:	src/crandom.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

# Continuously reads data from a Quantis hardware entropy generator,
# manufactured by ID Quantique, and writes it to standard output, or to a
# specified file system path.

QUANTIS_INCPATH=$(QUANTIS_ROOT)/Libs-Apps/Quantis
QUANTIS_LIBPATH=$(QUANTIS_ROOT)/Libs-Apps/build/Quantis

QUANTIS_CFLAGS += -I$(QUANTIS_INCPATH)
#QUANTIS_LDFLAGS += -L$(QUANTIS_LIBPATH)
#QUANTIS_LDFLAGS += -lQuantis
QUANTIS_LDFLAGS += $(QUANTIS_LIBPATH)/libQuantis.a
QUANTIS_LDFLAGS += -lusb-1.0
QUANTIS_LDFLAGS += -lpthread

$(OUT)/quantistool: src/quantistool.c
	$(CC) $(CFLAGS) $(QUANTIS_CFLAGS) -o $@ $^ $(LDFLAGS) $(QUANTIS_LDFLAGS)

################################################################################

# Continuously reads thirty-two bits of entropy using the rdrand or rdseed
# instructions available on various Intel processors such as certain models of
# the i7 and writes it to standard output, or to a specified file system path.

$(OUT)/seventool:	$(OUT)/seventool-mnemonic
	cp $^ $@

$(OUT)/seventool-binary: src/seventool.c
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

SEVEN_MNEMONIC += -DSCATTERGUN_HAS_RDRAND_MNEMONIC
SEVEN_MNEMONIC += -DSCATTERGUN_HAS_RDSEED_MNEMONIC

$(OUT)/seventool-mnemonic: src/seventool.c
	$(CC) $(CFLAGS) $(SEVEN_MNEMONIC) -o $@ $^ $(LDFLAGS)

SEVEN_INTRINSIC += -DSCATTERGUN_HAS_RDRAND_INTRINSIC
SEVEN_INTRINSIC += -DSCATTERGUN_HAS_RDSEED_INTRINSIC

$(OUT)/seventool-intrinsic: src/seventool.c
	$(CC) $(CFLAGS) $(SEVEN_INTRINSIC) -o $@ $^ $(LDFLAGS)

SEVEN_INLINE += -DSCATTERGUN_HAS_RDRAND_INLINE
SEVEN_INLINE += -DSCATTERGUN_HAS_RDSEED_INTRINSIC

$(OUT)/seventool-inline: src/seventool.c
	$(CC) $(CFLAGS) $(SEVEN_INLINE) -o $@ $^ $(LDFLAGS)

################################################################################

# Measures the sustained and peak rates of a data source. Optionally outputs
# a comma separated value (CSV) file of performance metrics with the specified
# period.

$(OUT)/rate:	src/rate.c
	$(CC) $(CFLAGS) -o $@ $^ ${LDFLAGS}

################################################################################

$(OUT)/characterize.sh:	bin/characterize.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/consume.sh:	bin/consume.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/entropy.sh:	bin/entropy.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/monitor.sh:	bin/monitor.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/onernginit.sh:	bin/onernginit.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/scattergun.sh:	bin/scattergun.sh
	cp $^ $@
	chmod 775 $@

$(OUT)/truerngd.sh:	bin/truerngd.sh
	cp $^ $@
	chmod 775 $@


################################################################################

$(OUT)/setup:
	cp /dev/null $@
	echo export PATH=$(shell pwd)/$(OUT):$(USNISTGOV_ROOT):$(PATH) >> $@
	echo export LD_LIBRARY_PATH=$(QUANTIS_LIBPATH):$(LD_LIBRARY_PATH) >> $@

export PATH:=$(shell pwd)/$(OUT):$(USNISTGOV_ROOT):$(PATH)
export LD_LIBRARY_PATH:=$(QUANTIS_LIBPATH):$(LD_LIBRARY_PATH)

################################################################################
# "Silver"
# Dell Inspiron 530
# Intel Core 2 Q6600 2.4GHz x4
# Ubuntu 14.04 "trusty"
# Linux 3.13.0
# gcc 4.8.2
################################################################################

# TrueRNGpro
# ublt.it
# US$99.00
# http://ubld.it/products/truerngpro
# 3.2Mbps
# USB
# semiconductor avalanche effect

TRUERNGPRO=scattergun_silver_TrueRNGpro

TrueRNGpro:	/dev/TrueRNGpro
	mkdir -p $(TRUERNGPRO)
	( dd if=/dev/TrueRNGpro | scattergun.sh $(TRUERNGPRO) ) > $(TRUERNGPRO)/scattergun.log 2>&1

.PHONY:	TrueRNGpro

################################################################################

# Quantis-USB-4M
# ID Quantique
# Euro$990.00 (US$1100.00)
# http://www.idquantique.com/random-number-generation/quantis-random-number-generator/
# 4Mbps
# USB
# beam splitter with photon counter

QUANTIS=scattergun_silver_quantis

quantis:	src/quantistool
	mkdir -p $(QUANTIS)
	( quantistool -v | scattergun.sh $(QUANTIS) ) > $(QUANTIS)/scattergun.log 2>&1

.PHONY:	quantis

################################################################################

# OneRNG
# Moonbase Otago
# US$40.00
# http://onerng.info
# 350Kbps
# USB
# semiconductor avalanche effect (and optionally atmospheric noise)

ONERNG=scattergun_silver_OneRNG

OneRNG:	/dev/OneRNG
	mkdir -p $(ONERNG)
	( dd if=/dev/OneRNG | scattergun.sh $(ONERNG) ) > $(ONERNG)/scattergun.log 2>&1

.PHONY:	OneRNG

################################################################################

# drivers/char/random.c

URANDOM=scattergun_silver_urandom

urandom:	/dev/urandom
	mkdir -p $(URANDOM)
	( dd if=/dev/urandom | scattergun.sh $(URANDOM) ) > $(URANDOM)/scattergun.log 2>&1

.PHONY:	urandom

################################################################################

# drivers/char/random.c

RANDOM=scattergun_silver_random

random:	/dev/random
	mkdir -p $(RANDOM)
	( dd if=/dev/random | scattergun.sh $(RANDOM) ) > $(RANDOM)/scattergun.log 2>&1

.PHONY:	random

################################################################################
# "Betty"
# Raspberry Pi 2 Model B v1.1
# Broadcom BCM2836 Cortex-A7 ARMv7 x4
# Raspbian (Debian) 7.8
# Linux 3.8.11
# gcc 4.6.3
################################################################################

# bcm2708 HWRNG
# Raspberry Pi 2 B (Broadcom BCM2836 SoC)
# US$35.00
# https://www.raspberrypi.org/products/raspberry-pi-2-model-b/
# undocumented
# drivers/char/hw_random/bcm2708-rng.c
# unknown

BCM2708=scattergun_betty_bcm2708

bcm2708:	/dev/random
	mkdir -p $(BCM2708)
	( dd if=/dev/hwrng | scattergun.sh $(BCM2708) ) > $(BCM2708)/scattergun.log 2>&1

.PHONY:	bcm2708

################################################################################
# "Mercury"
# Dell OptiPlex 7040
# Intel Core i7-6700T 2.8GHz x8
# Ubuntu 14.04.4 "trusty"
# Linux 4.2.0
# gcc 4.8.4
################################################################################

# TrueRNG
# ublt.it
# US$49.95
# http://ubld.it/products/truerng-hardware-random-number-generator/
# 350Kbps
# USB
# semiconductor avalanche effect

TRUERNG=scattergun_mercury_TrueRNG

TrueRNG:	/dev/TrueRNG
	mkdir -p $(TRUERNG)
	( dd if=/dev/TrueRNG | scattergun.sh $(TRUERNG) ) > $(TRUERNG)/scattergun.log 2>&1

.PHONY: TrueRNG

################################################################################

# rdrand Deterministic Random Bit Generator (DRBG)
# Intel Ivy Bridge family
# N/A
# https://software.intel.com/en-us/articles/intel-digital-random-number-generator-drng-software-implementation-guide
# 800MBps
# arch/x86/include/asm/archrandom.h
# AES-CBC-MAC, NIST SP800-90A compliant, thermal noise

RDRAND=scattergun_mercury_rdrand

rdrand:	$(OUT)/seventool
	mkdir -p $(RDRAND)
	( seventool -v -R -r -c | scattergun.sh $(RDRAND) ) > $(RDRAND)/scattergun.log 2>&1

.PHONY: rdrand

################################################################################

# rdseed Enhanced Non-deterministic Random Number Generator (ENRNG)
# Intel Broadwell family
# N/A
# https://software.intel.com/en-us/articles/intel-digital-random-number-generator-drng-software-implementation-guide
# N/A
# arch/x86/include/asm/archrandom.h
# NIST SP800-90B and C compliant, thermal noise

RDSEED=scattergun_mercury_rdseed

rdseed:	$(OUT)/seventool
	mkdir -p $(RDSEED)
	( seventool -v -S -c | scattergun.sh $(RDSEED) ) > $(RDSEED)/scattergun.log 2>&1

.PHONY: rdseed

################################################################################

FAIL=scattergun_mercury_fail

fail:	$(OUT)/seventool
	mkdir -p $(FAIL)
	( seventool -v | scattergun.sh $(FAIL) ) > $(FAIL)/scattergun.log 2>&1

.PHONY:	fail

################################################################################

CMRAND48=scattergun_mercury_cmrand48

cmrand48:	$(OUT)/cmrand48
	mkdir -p $(CMRAND48)
	( cmrand48 | scattergun.sh $(CMRAND48) ) > $(CMRAND48)/scattergun.log 2>&1

.PHONY:	cmrand48

################################################################################

CRANDOM=scattergun_mercury_crandom

crandom:	$(OUT)/crandom
	mkdir -p $(CRANDOM)
	( crandom | scattergun.sh $(CRANDOM) ) > $(CRANDOM)/scattergun.log 2>&1

.PHONY:	crandom

################################################################################

ZEROS=scattergun_mercury_zeros

zeros:	$(OUT)/bytes
	mkdir -p $(ZEROS)
	( bytes 0x00 | scattergun.sh $(ZEROS) ) > $(ZEROS)/scattergun.log 2>&1

.PHONY:	zeros

################################################################################
